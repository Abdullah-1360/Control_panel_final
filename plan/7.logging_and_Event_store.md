# Module 7: Logging & Event Store (Observability Platform)
## Professional Implementation Plan

**Version:** 3.0.0  
**Status:** Ready for Implementation  
**Dependencies:** All Modules (Module 1-6, Module 8)  
**Estimated Duration:** 3 weeks (120 hours)  
**Team Size:** 2 developers

---

## ðŸŽ¯ IMPLEMENTATION DECISIONS (Feb 11, 2026)

**Buffer:** 50 items or 500ms flush interval  
**Retention:** DEBUG 7d, INFO 30d, WARN 90d, ERROR 180d, CRITICAL 365d  
**Partitioning:** Deferred to Phase 2  
**PII Redaction:** Automatic for passwords, keys, tokens  
**Performance:** 10,000+ events/second, <100ms queries  
**SRE Focus:** Distributed tracing, correlation IDs, observability

---

## 1. Executive Summary

### 1.1 Business Value
The Logging & Event Store is the "memory" and "observability platform" of OpsManager, providing centralized, high-performance event capture, storage, and querying with distributed tracing capabilities. Enables comprehensive audit trails, forensic analysis, compliance reporting, operational intelligence, and full-stack observability following SRE best practices.

**Key Outcomes:** Complete audit trail for compliance, forensic analysis capabilities, operational intelligence, security monitoring, automated retention preventing database bloat, distributed tracing for debugging, correlation across services.

### 1.2 Technical Highlights
- High-performance buffered ingestion (10,000+ events/second)
- Intelligent PII/credential redaction
- Sub-100ms indexed queries
- Automated retention with BullMQ
- PostgreSQL JSONB for flexible metadata
- Unified logging interface for all modules
- **Distributed tracing with correlation IDs**
- **Trace context propagation across services**
- **Structured logging for observability**

### 1.3 Core Concepts
**System Event:** Immutable action record | **Event Stream:** Chronological resource events | **Redaction Engine:** Sensitive data sanitization | **Retention Policy:** Automated cleanup | **Contextual Search:** Resource-centric retrieval | **Buffered Ingestion:** Batch writes | **Correlation ID:** Unique identifier linking related events | **Trace Context:** Distributed tracing metadata | **Span:** Unit of work in distributed trace

---

## 2. Implementation Roadmap

### Sprint 1: Core Infrastructure (Week 1)
- Database schema with indexes
- LogService with buffered writes
- Redaction engine
- Integration with audit service
- Unit tests (>85% coverage)

### Sprint 2: Retention & Optimization (Week 2)
- Retention policies (7-365 days by level)
- BullMQ cleanup job (daily 3 AM)
- Database partitioning
- Index optimization
- Performance benchmarking

### Sprint 3: Query API & Frontend (Week 3)
- REST API for log queries
- Contextual search
- Log viewer UI
- Real-time polling
- CSV/JSON export
- E2E tests

---

## 3. Technical Architecture

**Data Flow:** Module Action â†’ LogService â†’ Redaction â†’ Buffer (100 events) â†’ Batch Insert â†’ PostgreSQL â†’ Query/Retention/Export

---

## 4. Database Schema

```prisma
model SystemLog {
  id              String   @id @default(uuid())
  
  // Classification
  level           LogLevel
  sourceModule    String   @db.VarChar(50)
  action          String   @db.VarChar(100)
  
  // Context
  resourceId      String?
  resourceType    String?  @db.VarChar(50)
  actorId         String?
  actor           User?    @relation(fields: [actorId], references: [id])
  ipAddress       String?  @db.Inet
  
  // Distributed Tracing (SRE)
  correlationId   String?  @db.VarChar(36) // UUID linking related events
  traceId         String?  @db.VarChar(32) // Distributed trace ID
  spanId          String?  @db.VarChar(16) // Span ID within trace
  parentSpanId    String?  @db.VarChar(16) // Parent span for hierarchy
  
  // Content
  message         String   @db.Text
  metadata        Json?
  
  // Timestamp
  createdAt       DateTime @default(now())
  
  @@index([resourceId, createdAt(sort: Desc)])
  @@index([actorId, createdAt(sort: Desc)])
  @@index([level, createdAt(sort: Desc)])
  @@index([action])
  @@index([sourceModule])
  @@index([createdAt(sort: Desc)])
  @@index([correlationId])
  @@index([traceId])
  @@map("system_logs")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}
```

---

## 5. API Specification

```http
GET    /api/v1/logs                    # Search logs
GET    /api/v1/logs/resource/:id       # Resource timeline
GET    /api/v1/logs/trace/:traceId     # Get full distributed trace
GET    /api/v1/logs/correlation/:id    # Get correlated events
GET    /api/v1/logs/export              # Export CSV/JSON
GET    /api/v1/logs/stats               # Statistics
DELETE /api/v1/logs/purge               # Manual purge (Super Admin)
```

---

## 6. Core Implementation

### LogService (Buffered)
```typescript
@Injectable()
export class LogService {
  private buffer: SystemEvent[] = [];
  private readonly BUFFER_SIZE = 100;
  private readonly FLUSH_INTERVAL = 1000;
  
  async log(event: SystemEvent): Promise<void> {
    const sanitized = this.redactionService.sanitize(event);
    this.buffer.push(sanitized);
    if (this.buffer.length >= this.BUFFER_SIZE) await this.flush();
  }
  
  private async flush(): Promise<void> {
    if (this.buffer.length === 0) return;
    const events = [...this.buffer];
    this.buffer = [];
    await this.prisma.systemLog.createMany({ data: events });
  }
}
```

### Redaction Engine
```typescript
@Injectable()
export class RedactionService {
  private sensitiveKeys = ['password', 'secret', 'key', 'token', 'auth', 'private_key'];
  private sensitivePatterns = [
    /-----BEGIN .*PRIVATE KEY-----[\s\S]*?-----END .*PRIVATE KEY-----/g,
    /AKIA[0-9A-Z]{16}/g, // AWS keys
    /eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*/g // JWT
  ];
  
  sanitize(event: SystemEvent): SystemEvent {
    return {
      ...event,
      message: this.redactString(event.message),
      metadata: this.redactObject(event.metadata)
    };
  }
}
```

### Retention Service
```typescript
@Injectable()
export class LogRetentionService {
  private retentionPolicies = {
    DEBUG: 7 * 24 * 60 * 60 * 1000,      // 7 days
    INFO: 30 * 24 * 60 * 60 * 1000,      // 30 days
    WARN: 90 * 24 * 60 * 60 * 1000,      // 90 days
    ERROR: 180 * 24 * 60 * 60 * 1000,    // 180 days
    CRITICAL: 365 * 24 * 60 * 60 * 1000  // 365 days
  };
  
  async pruneOldLogs(): Promise<PruneResult> {
    // Delete logs older than retention period by level
    // VACUUM ANALYZE to reclaim space
  }
}
```

---

## 7. Security Considerations

### RBAC Permissions
```typescript
const LOG_PERMISSIONS = {
  'logs.read': 'View system logs',
  'logs.export': 'Export logs',
  'logs.purge': 'Manually purge logs'
};

const ROLE_PERMISSIONS = {
  SUPER_ADMIN: ['logs.*'],
  ADMIN: ['logs.read', 'logs.export'],
  MANAGER: ['logs.read'],
  NOC: ['logs.read'],
  HELPDESK: [], // No log access
  HR: [], // No log access
  FINANCE: [] // No log access
};
```

### Redaction Patterns
- SSH private keys
- AWS/API keys
- JWT tokens
- Database URIs with passwords
- Credit card numbers
- Email addresses (PII)
- Password fields in metadata

---

## 8. Testing Strategy

### Unit Tests (>85% Coverage)
- Buffered write logic
- Redaction engine patterns
- Retention policy calculations
- Query service filters

### Integration Tests
- End-to-end logging flow
- Retention job execution
- Export functionality
- Real-time polling

### Performance Tests
- 10,000 events/second ingestion
- Query response <100ms
- Buffer flush timing
- Database index effectiveness

---

## 9. Performance Requirements

| Operation | Target | Maximum |
|-----------|--------|---------|
| Log ingestion | <1ms | 5ms |
| Buffer flush | <50ms | 100ms |
| Log search | <100ms | 200ms |
| Timeline query | <100ms | 200ms |
| Export (1000 logs) | <2s | 5s |

**Scalability:**
- Support 10,000+ events/second
- Store 100M+ log entries
- Query performance with 1B+ rows
- Retention job <5 minutes

---

## 10. Success Metrics

### Functional Metrics
- [ ] All modules integrated with LogService
- [ ] Redaction removes 100% of sensitive patterns
- [ ] Retention policies execute daily
- [ ] Export functionality works for CSV/JSON
- [ ] Real-time log viewing functional

### Performance Metrics
- [ ] Ingestion rate >10,000 events/second
- [ ] Query response times <100ms
- [ ] Buffer flush <50ms
- [ ] Database size optimized with retention

### Security Metrics
- [ ] 0 sensitive data in logs
- [ ] 100% of operations logged
- [ ] Audit trail immutable
- [ ] RBAC enforced on all endpoints

---

## 11. Tech Stack Alignment Checklist

- [x] **Backend:** NestJS + Prisma + PostgreSQL
- [x] **Job Queue:** BullMQ for retention jobs
- [x] **Caching:** Redis (via BullMQ)
- [x] **Frontend:** Next.js 14 + React Query + Zustand
- [x] **UI:** shadcn/ui + Tailwind CSS
- [x] **Validation:** class-validator decorators
- [x] **Auth:** JWT with RS256, RBAC enforcement
- [x] **Integration:** All modules (1-6, 8)

---

## 12. Documentation Deliverables

- Technical architecture documentation
- API reference (OpenAPI/Swagger)
- Redaction pattern guide
- Retention policy configuration guide
- Query API examples
- Integration guide for modules
- Troubleshooting guide
- Performance tuning guide

---

**Version:** 2.0.0  
**Last Updated:** February 7, 2026  
**Status:** Ready for Implementation  
**Estimated Completion:** 3 weeks from start date
