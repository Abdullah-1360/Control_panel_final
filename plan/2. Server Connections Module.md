# Phase 2: Server Connection Management Module
## Enterprise SSH & Remote Access Infrastructure

**Module ID:** PHASE-2-SERVER  
**Priority:** P0 (Foundation for Automation)  
**Estimated Duration:** 4-5 Weeks  
**Team Size:** 2 Backend Engineers, 1 Frontend Engineer  
**Status:** Ready for Implementation  
**Dependencies:** Module 1 (Authentication & Authorization)

---

## ðŸŽ¯ FINALIZED IMPLEMENTATION DECISIONS (February 8, 2026)

### Security
- **Encryption:** libsodium-wrappers with `SODIUM_MASTER_KEY` env var
- **Credential Rotation:** Manual only
- **File Upload Limit:** 10KB for SSH keys
- **Credential Sanitization:** Automatic in logs/API

### Data Management
- **Soft Delete:** 90-day purge policy
- **Dependency Checking:** Required before deletion
- **Source of Truth:** SSH scan over API data

### Performance
- **Connection Pool:** 20 connections
- **Connection Timeout:** 30 seconds

---

## Executive Summary

The Server Connection Management module provides secure, auditable, and scalable infrastructure for managing remote server connections. It serves as the foundation for all automation, monitoring, and operational activities by providing a unified connection layer that abstracts SSH complexity while maintaining enterprise-grade security.

### Business Value
- **Centralized Management:** Single source of truth for all server credentials
- **Security Compliance:** Encrypted credential storage, host key verification, comprehensive audit trails
- **Operational Efficiency:** Connection testing, dependency tracking, reusable connection profiles
- **Risk Mitigation:** Prevents credential sprawl, enforces security policies, tracks all access

### Technical Highlights
- Secure credential encryption using libsodium (XSalsa20-Poly1305)
- Multi-strategy host key verification (STRICT_PINNED, TOFU, DISABLED)
- Non-destructive connection testing with detailed diagnostics
- Dependency tracking prevents accidental deletion of in-use servers
- Support for SSH keys, passphrases, and password authentication
- Privilege escalation management (sudo with NOPASSWD or password)

---

## Implementation Roadmap

### Sprint 1: Core Infrastructure (Week 1)
**Goal:** Database schema, encryption service, and basic CRUD operations

#### Backend Tasks
1. **Database Schema & Migrations**
   - [ ] Design Server model with all connection fields
   - [ ] Create Prisma schema with proper indexes
   - [ ] Implement database migrations
   - [ ] Add seed data for testing
   - [ ] Create database constraints and validations

2. **Encryption Service**
   - [ ] Implement credential encryption using libsodium
   - [ ] Create encryption key management
   - [ ] Build encrypt/decrypt utility functions
   - [ ] Implement secure key storage
   - [ ] Add encryption performance optimization

3. **Server Service Foundation**
   - [ ] Create ServerService with dependency injection
   - [ ] Implement basic CRUD operations
   - [ ] Build validation logic for server profiles
   - [ ] Create error handling framework
   - [ ] Implement transaction management

#### Testing & Documentation
- [ ] Unit tests for encryption service (>90% coverage)
- [ ] Unit tests for validation logic
- [ ] Database migration testing
- [ ] API documentation setup (Swagger)

**Deliverables:**
- âœ… Working database schema
- âœ… Encryption service operational
- âœ… Basic CRUD operations
- âœ… Test coverage >80%

---

### Sprint 2: Connection Testing Framework (Week 2)
**Goal:** Implement comprehensive connection testing with detailed diagnostics

#### Backend Tasks
1. **SSH Connection Library**
   - [ ] Integrate ssh2 library
   - [ ] Create SSH connection wrapper
   - [ ] Implement connection pooling
   - [ ] Build timeout management
   - [ ] Create connection cleanup logic

2. **Connection Test Engine**
   - [ ] Implement DNS resolution step
   - [ ] Create TCP connection test
   - [ ] Build host key verification logic
   - [ ] Implement authentication testing
   - [ ] Create privilege escalation test
   - [ ] Build command execution test

3. **Test Result Management**
   - [ ] Create test result data model
   - [ ] Implement result storage
   - [ ] Build test history tracking
   - [ ] Create result sanitization (remove secrets)
   - [ ] Implement test metrics calculation

4. **Host Key Management**
   - [ ] Implement STRICT_PINNED verification
   - [ ] Create TOFU (Trust On First Use) logic
   - [ ] Build host key storage
   - [ ] Implement fingerprint comparison
   - [ ] Create security audit logging for key mismatches

#### Testing & Documentation
- [ ] Unit tests for connection logic
- [ ] Integration tests for SSH connections
- [ ] Mock SSH server for testing
- [ ] Connection test documentation

**Deliverables:**
- âœ… Working connection test framework
- âœ… Host key verification
- âœ… Detailed test diagnostics
- âœ… Test result history

---

### Sprint 3: API & Security (Week 3)
**Goal:** Complete REST API with security controls and audit logging

#### Backend Tasks
1. **REST API Endpoints**
   - [ ] POST /servers - Create server profile
   - [ ] GET /servers - List servers (paginated, filtered)
   - [ ] GET /servers/:id - Get server details
   - [ ] PATCH /servers/:id - Update server profile
   - [ ] DELETE /servers/:id - Delete server profile
   - [ ] POST /servers/:id/test - Test connection
   - [ ] GET /servers/:id/dependencies - Check dependencies

2. **RBAC Integration**
   - [ ] Implement permission guards
   - [ ] Create role-based filtering
   - [ ] Build ownership validation
   - [ ] Implement access control lists
   - [ ] Create permission audit logging

3. **Dependency Tracking**
   - [ ] Build dependency checking service
   - [ ] Implement cross-module dependency queries
   - [ ] Create force-delete logic (SUPER_ADMIN only)
   - [ ] Build dependency visualization data
   - [ ] Implement cascade prevention

4. **Audit Logging**
   - [ ] Log server creation/updates/deletion
   - [ ] Log credential changes
   - [ ] Log connection test results
   - [ ] Log host key changes
   - [ ] Log security events (key mismatches, etc.)

#### Testing & Documentation
- [ ] API endpoint testing (all CRUD operations)
- [ ] RBAC enforcement testing
- [ ] Dependency tracking testing
- [ ] Audit log verification
- [ ] Complete Swagger documentation

**Deliverables:**
- âœ… Complete REST API
- âœ… RBAC enforcement
- âœ… Dependency tracking
- âœ… Comprehensive audit logging

---

### Sprint 4: Frontend Implementation (Week 4)
**Goal:** User interface for server management

#### Frontend Tasks
1. **Server List Page**
   - [ ] Create server list table component
   - [ ] Implement pagination
   - [ ] Build filtering (platform, environment, status)
   - [ ] Create search functionality
   - [ ] Add sorting capabilities
   - [ ] Implement status indicators
   - [ ] Build action buttons (Test, Edit, Delete)

2. **Server Create/Edit Form**
   - [ ] Design multi-step form layout
   - [ ] Implement basic information section
   - [ ] Create connection details section
   - [ ] Build authentication section
   - [ ] Implement privilege & execution section
   - [ ] Create host key verification section
   - [ ] Add form validation with Zod
   - [ ] Implement real-time validation feedback

3. **Server Detail Page**
   - [ ] Create detail page layout
   - [ ] Build overview tab
   - [ ] Implement test results tab
   - [ ] Create host keys tab
   - [ ] Build dependencies tab
   - [ ] Implement audit log tab
   - [ ] Add real-time status updates

4. **Connection Test UI**
   - [ ] Create test modal/drawer
   - [ ] Build progress indicator
   - [ ] Implement step-by-step display
   - [ ] Create result visualization
   - [ ] Add error handling display
   - [ ] Implement retry functionality

#### State Management
- [ ] Setup React Query for server data
- [ ] Create Zustand store for UI state
- [ ] Implement optimistic updates
- [ ] Build cache invalidation logic
- [ ] Create real-time polling for tests

#### Testing & Documentation
- [ ] Component unit tests
- [ ] Integration tests for forms
- [ ] E2E tests for critical flows
- [ ] User documentation

**Deliverables:**
- âœ… Complete server management UI
- âœ… Intuitive user experience
- âœ… Real-time updates
- âœ… Responsive design

---

### Sprint 5: Polish & Production Readiness (Week 5)
**Goal:** Performance optimization, security hardening, and production deployment

#### Backend Tasks
1. **Performance Optimization**
   - [ ] Implement database query optimization
   - [ ] Add connection pooling
   - [ ] Create caching strategy (Redis)
   - [ ] Optimize encryption operations
   - [ ] Implement batch operations

2. **Security Hardening**
   - [ ] Conduct security audit
   - [ ] Implement rate limiting
   - [ ] Add input sanitization
   - [ ] Create SQL injection prevention
   - [ ] Implement command injection prevention
   - [ ] Add CSRF protection

3. **Error Handling & Resilience**
   - [ ] Implement comprehensive error handling
   - [ ] Create retry logic for transient failures
   - [ ] Build circuit breakers
   - [ ] Implement graceful degradation
   - [ ] Create health check endpoints

#### Frontend Tasks
1. **UX Polish**
   - [ ] Implement loading states
   - [ ] Create error boundaries
   - [ ] Add success/error notifications
   - [ ] Implement keyboard shortcuts
   - [ ] Create accessibility improvements (WCAG AA)

2. **Performance Optimization**
   - [ ] Implement code splitting
   - [ ] Add lazy loading
   - [ ] Optimize bundle size
   - [ ] Create service worker (PWA)
   - [ ] Implement image optimization

#### Testing & Documentation
- [ ] Load testing (1000+ servers)
- [ ] Stress testing
- [ ] Security penetration testing
- [ ] Complete user documentation
- [ ] Create admin guide
- [ ] Write troubleshooting guide

**Deliverables:**
- âœ… Production-ready system
- âœ… Performance optimized
- âœ… Security hardened
- âœ… Complete documentation

---

## Technical Architecture

### System Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (Next.js)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Server List  â”‚  â”‚ Server Form  â”‚  â”‚ Test Modal   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼ REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API Layer (NestJS)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Auth Guard   â”‚  â”‚ RBAC Guard   â”‚  â”‚ Rate Limiter â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Business Logic Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ServerService â”‚  â”‚ TestService  â”‚  â”‚ EncryptSvc   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Infrastructure Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚    Redis     â”‚  â”‚  SSH Client  â”‚ â”‚
â”‚  â”‚  (Servers)   â”‚  â”‚   (Cache)    â”‚  â”‚   (ssh2)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Connection Test Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DNS Resolution                                        â”‚
â”‚    â””â”€> Resolve hostname to IP address                   â”‚
â”‚        â”œâ”€ Success: Record IP and time                   â”‚
â”‚        â””â”€ Failure: Stop and return error                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TCP Connection                                        â”‚
â”‚    â””â”€> Connect to host:port                             â”‚
â”‚        â”œâ”€ Success: Record connection time               â”‚
â”‚        â””â”€ Failure: Stop and return error                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Host Key Verification                                 â”‚
â”‚    â””â”€> Verify SSH host key                              â”‚
â”‚        â”œâ”€ STRICT_PINNED: Compare against known keys     â”‚
â”‚        â”œâ”€ TOFU: Accept and store on first use           â”‚
â”‚        â””â”€ DISABLED: Skip verification (log warning)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Authentication                                        â”‚
â”‚    â””â”€> Authenticate with credentials                    â”‚
â”‚        â”œâ”€ SSH Key: Use private key                      â”‚
â”‚        â”œâ”€ SSH Key + Passphrase: Decrypt and use         â”‚
â”‚        â””â”€ Password: Use password authentication         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Privilege Test                                        â”‚
â”‚    â””â”€> Test sudo access (if applicable)                 â”‚
â”‚        â”œâ”€ NOPASSWD: Test sudo without password          â”‚
â”‚        â””â”€ PASSWORD_REQUIRED: Test with sudo password    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Command Execution                                     â”‚
â”‚    â””â”€> Run minimal read-only commands                   â”‚
â”‚        â”œâ”€ whoami: Verify username                       â”‚
â”‚        â””â”€ uname -a: Detect OS                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Cleanup & Results                                     â”‚
â”‚    â””â”€> Close connection and return results              â”‚
â”‚        â”œâ”€ Calculate total latency                       â”‚
â”‚        â”œâ”€ Sanitize output (remove secrets)              â”‚
â”‚        â””â”€ Store test result in database                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Schema


# Server Connections Module - Functional Requirements
## WP-AutoHealer Foundation Layer

**Version:** 1.0.0  
**Module:** Foundation/Server-Connections  
**Status:** Draft - Awaiting Clarifications  
**Date:** January 28, 2026

---

## 1. Module Overview

### 1.1 Purpose
Provide a unified, secure, auditable system to define and manage remote server connection profiles, securely store credentials, verify server identity, test connectivity, and enable other modules to reuse validated server connections.

### 1.2 Scope
This module manages server connection profiles and credentials. It does NOT execute commands or manage workloads - it provides connection primitives for other modules.

### 1.3 Module Boundaries

**In Scope:**
- Server profile management (CRUD)
- Secure credential storage (encrypted at rest)
- Host key verification and management
- Connection testing (non-destructive)
- Dependency tracking (prevent deletion of in-use servers)
- REST API for server management
- Admin UI for server configuration
- Audit logging for all security-relevant actions

**Out of Scope:**
- Command execution (handled by SSH Executor module)
- Workload scheduling
- Server monitoring/health checks (separate module)
- File transfer operations
- Server provisioning/deprovisioning

### 1.4 Dependencies

**Depends On:**
- Auth Module (for RBAC, user context, audit logging)
- Encryption Service (from Auth Module or standalone - needs clarification)
- Database (PostgreSQL - shared with Auth or separate - needs clarification)
- Redis (for connection pooling/caching - if applicable)

**Depended Upon By:**
- Site Management Module
- SSH Executor Module  
- Incident Management Module
- Any module requiring remote server access

---

## 2. Detailed Functional Requirements

### 2.1 Server Profile Management

#### FR-SERVER-001: Create Server Profile
**Description:** User creates a new server connection profile.

**Actors:** SUPER_ADMIN, ADMIN

**Preconditions:**
- User is authenticated
- User has `servers.create` permission

**Input:**
```typescript
{
  // Identity
  name: string (required, 3-100 chars, unique per tenant)
  environment: 'PROD' | 'STAGING' | 'DEV' | null
  tags: string[] (optional, max 20 tags, each 1-50 chars)
  notes: string (optional, max 1000 chars)
  
  // Connection
  platformType: 'LINUX' | 'WINDOWS' (required)
  host: string (required, hostname or IP)
  port: number (required, 1-65535)
  connectionProtocol: string (required)
  username: string (required, 1-100 chars)
  
  // Authentication
  authType: 'SSH_KEY' | 'SSH_KEY_WITH_PASSPHRASE' | 'PASSWORD' (required)
  credentials: {
    // For SSH_KEY:
    privateKey?: string (PEM format)
    
    // For SSH_KEY_WITH_PASSPHRASE:
    privateKey?: string (PEM format)
    passphrase?: string
    
    // For PASSWORD:
    password?: string
  }
  
  // Privilege & Execution
  privilegeMode: 'ROOT' | 'SUDO' | 'USER_ONLY' (required)
  sudoMode: 'NONE' | 'NOPASSWD' | 'PASSWORD_REQUIRED' (required)
  sudoPassword?: string (required if sudoMode = PASSWORD_REQUIRED)
  
  // Host Key Verification
  hostKeyStrategy: 'STRICT_PINNED' | 'TOFU' | 'DISABLED' (required, default: STRICT_PINNED)
  knownHostFingerprints?: {
    keyType: string (e.g., 'ssh-rsa', 'ssh-ed25519')
    fingerprint: string (SHA256)
  }[]
}
```

**Process:**
1. Validate all input fields
2. Check name uniqueness (per tenant if multi-tenant)
3. Validate host (DNS resolution or IP format)
4. Validate port range (1-65535)
5. Validate username format
6. Validate credential format based on authType
7. If SSH key provided:
   - Validate PEM format
   - Validate key is not password-protected if authType = SSH_KEY
   - Validate passphrase provided if authType = SSH_KEY_WITH_PASSPHRASE
8. Validate privilegeMode and sudoMode compatibility
9. If sudoMode = PASSWORD_REQUIRED, ensure sudoPassword provided
10. Validate hostKeyStrategy
11. If hostKeyStrategy = STRICT_PINNED and no fingerprints provided, return error
12. Encrypt all credential fields (privateKey, passphrase, password, sudoPassword)
13. Generate unique serverId (UUID)
14. Store server profile in database
15. Create audit log entry (action: SERVER_CREATED)
16. Return server profile (without decrypted credentials)

**Output:**
```typescript
{
  serverId: string (UUID)
  name: string
  environment: string
  tags: string[]
  platformType: string
  host: string
  port: number
  connectionProtocol: string
  username: string
  authType: string
  privilegeMode: string
  sudoMode: string
  hostKeyStrategy: string
  knownHostFingerprints: { keyType, fingerprint, firstSeenAt }[]
  lastTestStatus: 'NEVER_TESTED'
  lastTestAt: null
  createdByUserId: string
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Business Rules:**
- Server name must be unique (per tenant if multi-tenant)
- Credentials immediately encrypted on receipt
- Host key strategy STRICT_PINNED is default and recommended
- If TOFU or DISABLED selected, log warning-level audit event
- Cannot create server with DISABLED host key verification unless system policy allows

**Error Conditions:**
- Name already exists â†’ 409 Conflict
- Invalid hostname/IP â†’ 400 Bad Request
- Invalid port â†’ 400 Bad Request
- Invalid SSH key format â†’ 400 Bad Request
- Missing required credentials â†’ 400 Bad Request
- STRICT_PINNED without fingerprints â†’ 400 Bad Request
- DISABLED host key verification when policy disallows â†’ 403 Forbidden
- No permission â†’ 403 Forbidden

---

#### FR-SERVER-002: List Server Profiles
**Description:** User retrieves list of server profiles.

**Actors:** All authenticated users (filtered by RBAC)

**Preconditions:**
- User is authenticated
- User has `servers.read` permission

**Input (Query Parameters):**
```typescript
{
  page?: number (default: 1)
  limit?: number (default: 50, max: 100)
  sort?: string (default: 'name', options: name, createdAt, lastTestAt)
  order?: 'asc' | 'desc' (default: 'asc')
  
  // Filters
  search?: string (searches name, host, tags)
  platformType?: 'LINUX' | 'WINDOWS'
  environment?: 'PROD' | 'STAGING' | 'DEV'
  tags?: string[] (comma-separated)
  lastTestStatus?: 'NEVER_TESTED' | 'OK' | 'FAILED'
}
```

**Process:**
1. Validate query parameters
2. Apply RBAC filters (users see only servers they have access to)
3. Apply search filter (if provided)
4. Apply platform, environment, tags, status filters
5. Sort results
6. Paginate results
7. Return server list (without credentials)

**Output:**
```typescript
{
  data: ServerProfile[] (without credentials)
  pagination: {
    total: number
    page: number
    limit: number
    totalPages: number
  }
}
```

**Business Rules:**
- Credentials never included in list responses
- Search is case-insensitive
- SUPER_ADMIN sees all servers
- Other roles see servers based on RBAC rules

**Error Conditions:**
- Invalid pagination params â†’ 400 Bad Request
- No permission â†’ 403 Forbidden

---

#### FR-SERVER-003: Get Server Profile by ID
**Description:** User retrieves detailed server profile.

**Actors:** All authenticated users with access

**Preconditions:**
- User is authenticated
- User has `servers.read` permission
- User has access to specific server (RBAC)

**Input:**
- serverId (UUID, required)

**Process:**
1. Validate serverId format
2. Check server exists
3. Verify user has access (RBAC)
4. Retrieve server profile
5. Return (without decrypted credentials)

**Output:**
```typescript
{
  serverId: string
  name: string
  environment: string
  tags: string[]
  notes: string
  platformType: string
  host: string
  port: number
  connectionProtocol: string
  username: string
  authType: string
  privilegeMode: string
  sudoMode: string
  hostKeyStrategy: string
  knownHostFingerprints: { keyType, fingerprint, firstSeenAt, lastVerifiedAt }[]
  lastTestStatus: 'NEVER_TESTED' | 'OK' | 'FAILED'
  lastTestAt: DateTime | null
  lastTestResult: {
    success: boolean
    message: string
    latency: number
    testedAt: DateTime
  } | null
  createdByUserId: string
  createdAt: DateTime
  updatedAt: DateTime
}
```

**Business Rules:**
- Credentials never returned (only their presence/type indicated)
- Last test result included if available

**Error Conditions:**
- Invalid serverId format â†’ 400 Bad Request
- Server not found â†’ 404 Not Found
- No permission â†’ 403 Forbidden

---

#### FR-SERVER-004: Update Server Profile
**Description:** User updates existing server profile.

**Actors:** SUPER_ADMIN, ADMIN

**Preconditions:**
- User is authenticated
- User has `servers.update` permission
- Server exists

**Input:**
```typescript
{
  // All fields optional, only provided fields updated
  name?: string
  environment?: 'PROD' | 'STAGING' | 'DEV' | null
  tags?: string[]
  notes?: string
  host?: string
  port?: number
  username?: string
  
  // Credentials update (if any credential field provided, all credentials for that authType must be provided)
  authType?: 'SSH_KEY' | 'SSH_KEY_WITH_PASSPHRASE' | 'PASSWORD'
  credentials?: {
    privateKey?: string
    passphrase?: string
    password?: string
  }
  
  privilegeMode?: 'ROOT' | 'SUDO' | 'USER_ONLY'
  sudoMode?: 'NONE' | 'NOPASSWD' | 'PASSWORD_REQUIRED'
  sudoPassword?: string
  
  hostKeyStrategy?: 'STRICT_PINNED' | 'TOFU' | 'DISABLED'
  knownHostFingerprints?: { keyType, fingerprint }[]
}
```

**Process:**
1. Validate serverId
2. Check server exists
3. Verify user has permission
4. Validate provided fields
5. If name changed, check uniqueness
6. If credentials changed:
   - Validate new credentials
   - Encrypt new credentials
   - Delete old credentials
   - Create audit log (CREDENTIALS_UPDATED)
7. If host/port changed:
   - Clear lastTestStatus (set to NEVER_TESTED)
   - Create audit log (CONNECTION_DETAILS_CHANGED)
8. If host key strategy or fingerprints changed:
   - Create audit log (HOST_KEY_CONFIG_CHANGED)
9. Update server profile
10. Update updatedAt timestamp
11. Return updated profile (without credentials)

**Output:**
Same as FR-SERVER-003 output

**Business Rules:**
- Partial updates allowed
- Credential update requires all fields for the authType
- Changing host/port invalidates last test result
- Name must remain unique
- Cannot change platformType after creation
- Cannot change connectionProtocol after creation (would require new server)

**Error Conditions:**
- Server not found â†’ 404 Not Found
- Name conflict â†’ 409 Conflict
- Invalid credential format â†’ 400 Bad Request
- Incomplete credentials for authType â†’ 400 Bad Request
- No permission â†’ 403 Forbidden

---

#### FR-SERVER-005: Delete Server Profile
**Description:** User deletes server profile (with dependency check).

**Actors:** SUPER_ADMIN, ADMIN

**Preconditions:**
- User is authenticated
- User has `servers.delete` permission
- Server exists

**Input:**
- serverId (UUID, required)
- force?: boolean (optional, default: false - needs clarification on policy)

**Process:**
1. Validate serverId
2. Check server exists
3. Verify user has permission
4. Check dependencies:
   - Active sites using this server
   - Active/recent incidents referencing this server
   - Scheduled jobs using this server
   - Any other module references
5. If dependencies exist:
   - If force = false or not allowed:
     - Return error with dependency list
   - If force = true and allowed by policy:
     - Log critical audit event (FORCED_DELETION)
     - Proceed with deletion
6. If no dependencies or force allowed:
   - Soft-delete: Set deletedAt timestamp
   - OR Hard-delete: Remove from database (needs clarification)
   - Securely wipe encrypted credentials from database
   - Create audit log (SERVER_DELETED)
7. Return success

**Output:**
```typescript
{
  success: true,
  message: 'Server deleted successfully'
}
```

**Business Rules:**
- Cannot delete server with active dependencies (unless force allowed)
- Soft-delete recommended for audit trail
- Credentials securely wiped on deletion
- Deletion requires explicit permission
- Force deletion (if allowed) requires SUPER_ADMIN and creates critical audit event

**Error Conditions:**
- Server not found â†’ 404 Not Found
- Has dependencies and force not allowed â†’ 409 Conflict with dependency details
- Force deletion not allowed by policy â†’ 403 Forbidden
- No permission â†’ 403 Forbidden

---

#### FR-SERVER-006: Get Server Dependencies
**Description:** User retrieves list of resources depending on this server.

**Actors:** SUPER_ADMIN, ADMIN

**Preconditions:**
- User is authenticated
- User has `servers.read` permission
- Server exists

**Input:**
- serverId (UUID, required)

**Process:**
1. Validate serverId
2. Check server exists
3. Verify user has permission
4. Query all modules for dependencies:
   - Sites using this server
   - Recent/active incidents
   - Scheduled jobs
   - Other references
5. Aggregate dependency list
6. Return grouped by type

**Output:**
```typescript
{
  serverId: string,
  serverName: string,
  hasDependencies: boolean,
  dependencies: {
    sites: {
      count: number,
      items: { id, domain, status }[]
    },
    incidents: {
      count: number,
      items: { id, status, createdAt }[]
    },
    jobs: {
      count: number,
      items: { id, name, schedule }[]
    },
    // Other module dependencies...
  }
}
```

**Business Rules:**
- Shows all blocking dependencies
- Limited to recent incidents (last 30 days or active)
- Provides enough detail to understand impact

**Error Conditions:**
- Server not found â†’ 404 Not Found
- No permission â†’ 403 Forbidden

---

### 2.2 Connection Testing

#### FR-SERVER-007: Test Server Connection
**Description:** Execute safe, non-destructive connection test.

**Actors:** SUPER_ADMIN, ADMIN, ENGINEER

**Preconditions:**
- User is authenticated
- User has `servers.test` permission
- Server profile exists

**Input:**
- serverId (UUID, required)

**Process:**
1. Validate serverId
2. Check server exists
3. Verify user has permission
4. Retrieve server profile with decrypted credentials
5. Begin connection test (async operation):
   
   a) **DNS Resolution** (if hostname)
      - Resolve hostname to IP
      - Record resolution time
      - If fails, stop and record error
   
   b) **TCP Connection**
      - Attempt TCP connection to host:port
      - Record connection time
      - Timeout: <NEEDS CLARIFICATION - suggest 30s>
      - If fails, stop and record error
   
   c) **Host Key Verification**
      - Retrieve server's SSH host key
      - If hostKeyStrategy = STRICT_PINNED:
        - Compare against knownHostFingerprints
        - If mismatch: FAIL and log security event
        - If match: Continue
      - If hostKeyStrategy = TOFU:
        - If first connection: Accept and store fingerprint
        - If subsequent: Compare against stored
        - Log warning if new fingerprint
      - If hostKeyStrategy = DISABLED:
        - Skip verification
        - Log critical security warning
   
   d) **Authentication**
      - Authenticate based on authType
      - If fails, record error and stop
   
   e) **Privilege Test** (if applicable)
      - If privilegeMode = SUDO:
        - Test sudo access
        - If sudoMode = PASSWORD_REQUIRED, use sudoPassword
        - If fails, record warning (not critical error)
   
   f) **Minimal Command Execution**
      - Linux:
        - Run: `whoami` (verify username)
        - Run: `uname -a` (get OS info)
      - Windows:
        - Run: <NEEDS CLARIFICATION - minimal equivalent>
      - Record stdout/stderr
      - Sanitize output (remove potential secrets)
      - Verify expected username matches
   
   g) **Cleanup**
      - Close connection
      - Calculate total latency

6. Store test result in database:
   - success: boolean
   - message: string
   - latency: number (ms)
   - testedAt: DateTime
   - detectedOS: string (from uname or equivalent)
   - detectedUsername: string (from whoami)
   - errors: string[] (if any)
   - warnings: string[] (if any)

7. Update server profile:
   - lastTestStatus: 'OK' | 'FAILED'
   - lastTestAt: DateTime
   - If hostKeyStrategy = TOFU and new fingerprint:
     - Add to knownHostFingerprints
     - Update lastVerifiedAt

8. Create audit log entry:
   - action: CONNECTION_TEST_SUCCESS or CONNECTION_TEST_FAILED
   - severity: based on result
   - metadata: sanitized test result

9. Return test result

**Output:**
```typescript
{
  success: boolean,
  message: string,
  latency: number,
  testedAt: DateTime,
  details: {
    dnsResolution: { success: boolean, ip?: string, time: number },
    tcpConnection: { success: boolean, time: number },
    hostKeyVerification: { success: boolean, keyType?: string, fingerprint?: string, matched?: boolean },
    authentication: { success: boolean },
    privilegeTest: { success: boolean, hasRoot?: boolean, hasSudo?: boolean },
    commandExecution: {
      whoami: { success: boolean, output?: string },
      systemInfo: { success: boolean, output?: string }
    }
  },
  detectedOS: string,
  detectedUsername: string,
  errors: string[],
  warnings: string[]
}
```

**Business Rules:**
- Test is completely non-destructive
- No server state modifications allowed
- Commands must be read-only
- Timeout for entire test: <NEEDS CLARIFICATION - suggest 60s>
- Test can be run multiple times without side effects
- Failed test does not block future tests (no lockout)
- Successful test updates lastTestStatus immediately
- Host key mismatch creates CRITICAL security audit event
- TOFU first-use creates WARNING audit event
- DISABLED host key verification creates CRITICAL audit event

**Error Conditions:**
- Server not found â†’ 404 Not Found
- No permission â†’ 403 Forbidden
- Connection timeout â†’ 504 Gateway Timeout
- Authentication failed â†’ 401 Unauthorized (logged, not exposed to user)
- Host key mismatch â†’ 403 Forbidden with security warning

---

### 2.3 Host Key Management

#### FR-SERVER-008: Update Known Host Fingerprints
**Description:** Admin updates stored host key fingerprints (for legitimate key rotation).

**Actors:** SUPER_ADMIN

**Preconditions:**
- User is authenticated
- User has `servers.update` permission (SUPER_ADMIN only for security)
- Server exists

**Input:**
```typescript
{
  serverId: string (UUID, required)
  action: 'ADD' | 'REMOVE' | 'REPLACE' (required)
  fingerprints: {
    keyType: string
    fingerprint: string
  }[]
  reason: string (required, audit trail)
}
```

**Process:**
1. Validate serverId
2. Check server exists
3. Verify user is SUPER_ADMIN
4. Validate fingerprints format
5. Based on action:
   - ADD: Append to knownHostFingerprints
   - REMOVE: Remove specified fingerprints
   - REPLACE: Replace all fingerprints
6. Update lastVerifiedAt for affected fingerprints
7. Set lastTestStatus = NEVER_TESTED (require re-test)
8. Create audit log (HOST_KEYS_UPDATED, severity: HIGH)
9. Return updated server profile

**Output:**
Same as FR-SERVER-003

**Business Rules:**
- Requires SUPER_ADMIN only (high security action)
- Must provide reason for audit trail
- Triggers re-test requirement
- Cannot remove all fingerprints if strategy is STRICT_PINNED

**Error Conditions:**
- Server not found â†’ 404 Not Found
- Invalid fingerprint format â†’ 400 Bad Request
- Removing all fingerprints with STRICT_PINNED â†’ 400 Bad Request
- Not SUPER_ADMIN â†’ 403 Forbidden

---

#### FR-SERVER-009: Host Key Verification on Connection
**Description:** System verifies host key on every connection (automatic).

**Actors:** System (automatic)

**Trigger:** Any connection attempt to server

**Process:**
1. Retrieve server's current SSH host key
2. Based on hostKeyStrategy:
   
   **STRICT_PINNED:**
   - Compare against knownHostFingerprints
   - If match found: Allow connection
   - If no match: DENY connection
   - Create audit log (severity: CRITICAL if denied)
   
   **TOFU:**
   - If knownHostFingerprints is empty: Accept and store
   - If knownHostFingerprints exists: Compare
   - If match: Allow connection
   - If mismatch: DENY connection and create security alert
   
   **DISABLED:**
   - Allow connection without verification
   - Create audit log (severity: CRITICAL) on every connection

3. Update lastVerifiedAt if verification succeeded

**Business Rules:**
- Runs on EVERY connection (no caching)
- Host key mismatch is a security incident
- DISABLED strategy logs every connection as security risk
- System admin notified of any host key mismatches

---

### 2.4 Security & Encryption

#### FR-SERVER-010: Credential Encryption
**Description:** All sensitive credentials encrypted at rest.

**Encryption Target Fields:**
- privateKey (SSH keys)
- passphrase (for encrypted SSH keys)
- password (authentication password)
- sudoPassword

**Encryption Requirements:**
- Algorithm: <NEEDS CLARIFICATION - libsodium XSalsa20-Poly1305 from Auth module?>
- Key storage: <NEEDS CLARIFICATION - shared with Auth module or separate?>
- Key rotation: <NEEDS CLARIFICATION - supported now or future?>

**Process:**
1. On credential write (create/update):
   - Validate credential format
   - Encrypt using application encryption key
   - Store encrypted blob
   - Never log or expose raw credential
   
2. On credential read (for connection use):
   - Decrypt using application encryption key
   - Use in memory only
   - Never log decrypted value
   - Clear from memory after use

**Business Rules:**
- Credentials encrypted immediately on receipt
- Decryption only when needed for connection
- No credential caching in memory
- Raw credentials never logged, never in API responses
- Encryption key never exposed via API

---

#### FR-SERVER-011: Credential Sanitization in Logs
**Description:** Ensure no credentials leak into logs or API responses.

**Sanitization Rules:**
1. **API Responses:**
   - Never include decrypted credentials
   - Indicate credential type/presence only
   - Example: `"hasPrivateKey": true` instead of actual key

2. **Audit Logs:**
   - Log credential updates (fact, not value)
   - Sanitize any command output that might contain credentials
   - Redact common credential patterns (passwords, keys, tokens)

3. **Error Messages:**
   - Never include credential in error messages
   - Example: "Authentication failed" not "Password 'xyz' is incorrect"

4. **Test Results:**
   - Sanitize stdout/stderr from connection tests
   - Remove environment variables
   - Remove sudo passwords if echoed

**Sanitization Patterns:**
```regex
- Password patterns: password[=:]\s*\S+
- Key patterns: -----BEGIN .* KEY-----.*-----END .* KEY-----
- Token patterns: token[=:]\s*\S+
- API key patterns: api[-_]?key[=:]\s*\S+
```

**Business Rules:**
- Sanitization applied before any storage or transmission
- Regular expression patterns updated as needed
- Over-redaction preferred over under-redaction

---

### 2.5 RBAC & Permissions

#### FR-SERVER-012: Permission Requirements

**Required Permissions:**

| Action | Required Permission | Roles with Permission |
|--------|-------------------|----------------------|
| Create server | servers.create | SUPER_ADMIN, ADMIN |
| List servers | servers.read | ALL |
| View server details | servers.read | ALL |
| Update server | servers.update | SUPER_ADMIN, ADMIN |
| Delete server | servers.delete | SUPER_ADMIN, ADMIN |
| Test connection | servers.test | SUPER_ADMIN, ADMIN, ENGINEER |
| Update host keys | servers.update + SUPER_ADMIN role | SUPER_ADMIN only |

**Business Rules:**
- SUPER_ADMIN can perform all actions
- ADMIN can manage servers but cannot update host keys
- ENGINEER can only read and test (cannot modify)
- VIEWER can only read (cannot test or modify)
- Permission checks enforced on every API endpoint
- Failed permission checks logged in audit log

---

### 2.6 Audit Logging

#### FR-SERVER-013: Audit Events

**Events to Log:**

| Event Type | Severity | Trigger |
|-----------|----------|---------|
| SERVER_CREATED | INFO | Server profile created |
| SERVER_UPDATED | INFO | Server profile updated |
| SERVER_DELETED | HIGH | Server profile deleted |
| SERVER_FORCE_DELETED | CRITICAL | Server deleted with dependencies |
| CREDENTIALS_UPDATED | HIGH | Credentials changed |
| HOST_KEYS_UPDATED | HIGH | Host key fingerprints modified |
| CONNECTION_TEST_SUCCESS | INFO | Connection test succeeded |
| CONNECTION_TEST_FAILED | WARNING | Connection test failed |
| HOST_KEY_MISMATCH | CRITICAL | Host key verification failed |
| HOST_KEY_TOFU_ACCEPT | WARNING | First-time host key accepted |
| HOST_KEY_VERIFICATION_DISABLED | CRITICAL | Connection with disabled verification |
| CONNECTION_DETAILS_CHANGED | WARNING | Host or port changed |

**Audit Log Fields:**
```typescript
{
  id: string (UUID)
  timestamp: DateTime
  userId: string (actor)
  actorType: 'USER' | 'SYSTEM'
  action: string (event type above)
  resource: 'server'
  resourceId: string (serverId)
  severity: 'INFO' | 'WARNING' | 'HIGH' | 'CRITICAL'
  description: string
  metadata: {
    serverName?: string
    host?: string
    platformType?: string
    authType?: string
    hostKeyStrategy?: string
    testResult?: object (sanitized)
    dependencies?: object
    // ... other relevant data
  }
  ipAddress: string
  userAgent: string
}
```

**Business Rules:**
- All security-relevant actions logged
- Audit logs immutable (append-only)
- Logs retained per system retention policy (90 days minimum)
- CRITICAL events trigger immediate notifications to admins
- Audit logs accessible via API and UI

---

## 3. Data Models

### 3.1 Server Profile

```typescript
{
  // Identity
  serverId: string (UUID, PK)
  name: string (unique per tenant, indexed)
  environment: 'PROD' | 'STAGING' | 'DEV' | null
  tags: string[] (searchable, indexed)
  notes: string (max 1000 chars)
  
  // Connection
  platformType: 'LINUX' | 'WINDOWS' (immutable after creation)
  host: string (hostname or IP, indexed)
  port: number (1-65535)
  connectionProtocol: string (e.g., 'SSH', extensible)
  username: string
  
  // Authentication (encrypted)
  authType: 'SSH_KEY' | 'SSH_KEY_WITH_PASSPHRASE' | 'PASSWORD'
  encryptedPrivateKey: string? (binary blob, encrypted)
  encryptedPassphrase: string? (binary blob, encrypted)
  encryptedPassword: string? (binary blob, encrypted)
  
  // Privilege & Execution
  privilegeMode: 'ROOT' | 'SUDO' | 'USER_ONLY'
  sudoMode: 'NONE' | 'NOPASSWD' | 'PASSWORD_REQUIRED'
  encryptedSudoPassword: string? (binary blob, encrypted)
  
  // Host Key Verification
  hostKeyStrategy: 'STRICT_PINNED' | 'TOFU' | 'DISABLED'
  knownHostFingerprints: {
    keyType: string
    fingerprint: string (SHA256)
    firstSeenAt: DateTime
    lastVerifiedAt: DateTime
  }[] (JSON array)
  
  // Operational
  lastTestStatus: 'NEVER_TESTED' | 'OK' | 'FAILED'
  lastTestAt: DateTime?
  lastTestResult: {
    success: boolean
    message: string
    latency: number
    detectedOS: string
    detectedUsername: string
    errors: string[]
    warnings: string[]
    testedAt: DateTime
  }? (JSON)
  
  // Metadata
  createdByUserId: string (FK to User)
  createdAt: DateTime
  updatedAt: DateTime
  deletedAt: DateTime? (soft delete)
  
  // Indexes
  @@index([name])
  @@index([host])
  @@index([platformType])
  @@index([environment])
  @@index([lastTestStatus])
  @@index([deletedAt])
  @@unique([name]) // or @@unique([name, tenantId]) if multi-tenant
}
```

### 3.2 Server Dependencies (View/Query)

```typescript
// Not a stored table, but a computed view/query result
{
  serverId: string
  serverName: string
  dependencyType: 'site' | 'incident' | 'job' | ...
  dependencyId: string
  dependencyName: string
  createdAt: DateTime
  status: string
}
```

---

## 4. API Specification

### 4.1 REST API Endpoints

**Base URL:** `/api/v1/servers`

#### POST /servers
Create new server profile

**Request:**
```json
{
  "name": "Production Web Server 1",
  "environment": "PROD",
  "tags": ["web", "wordpress", "us-east"],
  "notes": "Main production server for client sites",
  "platformType": "LINUX",
  "host": "prod1.example.com",
  "port": 22,
  "connectionProtocol": "SSH",
  "username": "deployer",
  "authType": "SSH_KEY_WITH_PASSPHRASE",
  "credentials": {
    "privateKey": "-----BEGIN OPENSSH PRIVATE KEY-----\n...",
    "passphrase": "secure-passphrase-123"
  },
  "privilegeMode": "SUDO",
  "sudoMode": "NOPASSWD",
  "hostKeyStrategy": "STRICT_PINNED",
  "knownHostFingerprints": [
    {
      "keyType": "ssh-ed25519",
      "fingerprint": "SHA256:abc123..."
    }
  ]
}
```

**Response:** 201 Created
```json
{
  "serverId": "srv_abc123",
  "name": "Production Web Server 1",
  "environment": "PROD",
  "tags": ["web", "wordpress", "us-east"],
  "platformType": "LINUX",
  "host": "prod1.example.com",
  "port": 22,
  "username": "deployer",
  "authType": "SSH_KEY_WITH_PASSPHRASE",
  "privilegeMode": "SUDO",
  "sudoMode": "NOPASSWD",
  "hostKeyStrategy": "STRICT_PINNED",
  "knownHostFingerprints": [...],
  "lastTestStatus": "NEVER_TESTED",
  "lastTestAt": null,
  "createdAt": "2026-01-28T10:00:00Z",
  "updatedAt": "2026-01-28T10:00:00Z"
}
```

---

#### GET /servers
List server profiles (paginated, filterable)

**Query Parameters:**
- page (default: 1)
- limit (default: 50, max: 100)
- sort (default: name)
- order (default: asc)
- search
- platformType
- environment
- tags
- lastTestStatus

**Response:** 200 OK
```json
{
  "data": [
    { /* server profile without credentials */ },
    { /* server profile without credentials */ }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "limit": 50,
    "totalPages": 3
  }
}
```

---

#### GET /servers/:id
Get server profile details

**Response:** 200 OK
```json
{
  "serverId": "srv_abc123",
  "name": "Production Web Server 1",
  // ... full server profile without credentials
  "lastTestResult": {
    "success": true,
    "message": "Connection successful",
    "latency": 145,
    "detectedOS": "Ubuntu 24.04 LTS",
    "detectedUsername": "deployer",
    "testedAt": "2026-01-28T10:05:00Z"
  }
}
```

---

#### PATCH /servers/:id
Update server profile

**Request:**
```json
{
  "name": "Production Web Server 1 (Updated)",
  "tags": ["web", "wordpress", "us-east", "high-memory"]
}
```

**Response:** 200 OK
```json
{
  // Updated server profile
}
```

---

#### DELETE /servers/:id
Delete server profile

**Query Parameters:**
- force (optional, boolean)

**Response:** 200 OK
```json
{
  "success": true,
  "message": "Server deleted successfully"
}
```

**OR 409 Conflict (if dependencies exist):**
```json
{
  "success": false,
  "error": {
    "code": "HAS_DEPENDENCIES",
    "message": "Cannot delete server with active dependencies",
    "dependencies": {
      "sites": { "count": 3, "items": [...] },
      "incidents": { "count": 1, "items": [...] }
    }
  }
}
```

---

#### POST /servers/:id/test
Test server connection

**Response:** 200 OK
```json
{
  "success": true,
  "message": "Connection test successful",
  "latency": 145,
  "testedAt": "2026-01-28T10:10:00Z",
  "details": {
    "dnsResolution": { "success": true, "ip": "192.168.1.100", "time": 20 },
    "tcpConnection": { "success": true, "time": 45 },
    "hostKeyVerification": { "success": true, "keyType": "ssh-ed25519", "matched": true },
    "authentication": { "success": true },
    "privilegeTest": { "success": true, "hasSudo": true },
    "commandExecution": {
      "whoami": { "success": true, "output": "deployer" },
      "systemInfo": { "success": true, "output": "Linux prod1 5.15.0 Ubuntu" }
    }
  },
  "detectedOS": "Ubuntu 24.04 LTS",
  "detectedUsername": "deployer",
  "errors": [],
  "warnings": []
}
```

**OR 500 Internal Server Error (connection failed):**
```json
{
  "success": false,
  "message": "Connection test failed",
  "latency": 30000,
  "testedAt": "2026-01-28T10:10:00Z",
  "details": {
    "dnsResolution": { "success": true, "ip": "192.168.1.100", "time": 20 },
    "tcpConnection": { "success": false, "error": "Connection timeout" }
  },
  "errors": ["TCP connection timeout after 30 seconds"],
  "warnings": []
}
```

---

#### GET /servers/:id/dependencies
Get server dependencies

**Response:** 200 OK
```json
{
  "serverId": "srv_abc123",
  "serverName": "Production Web Server 1",
  "hasDependencies": true,
  "dependencies": {
    "sites": {
      "count": 3,
      "items": [
        { "id": "site_1", "domain": "example.com", "status": "active" },
        { "id": "site_2", "domain": "shop.example.com", "status": "active" },
        { "id": "site_3", "domain": "blog.example.com", "status": "active" }
      ]
    },
    "incidents": {
      "count": 1,
      "items": [
        { "id": "inc_1", "status": "IN_PROGRESS", "createdAt": "2026-01-28T09:00:00Z" }
      ]
    },
    "jobs": {
      "count": 0,
      "items": []
    }
  }
}
```

---

### 4.2 Error Responses

**Standard Error Format:**
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "details": {
      // Additional context
    },
    "requestId": "req_xyz789"
  }
}
```

**Common Error Codes:**
- VALIDATION_ERROR (400)
- UNAUTHORIZED (401)
- FORBIDDEN (403)
- NOT_FOUND (404)
- CONFLICT (409)
- HAS_DEPENDENCIES (409)
- INTERNAL_ERROR (500)
- CONNECTION_TIMEOUT (504)

---

## 5. Backend UI Requirements

### 5.1 Server List Page

**Path:** `/servers`

**Components:**
1. **Header**
   - Title: "Servers"
   - "Add Server" button (if has permission)
   - Search bar (real-time search)
   
2. **Filters**
   - Platform type dropdown (All, Linux, Windows)
   - Environment dropdown (All, Production, Staging, Dev)
   - Status dropdown (All, OK, Failed, Never Tested)
   - Tags multi-select
   
3. **Server Table**
   - Columns:
     - Status indicator (green=OK, red=Failed, gray=Never Tested)
     - Name (linked to detail page)
     - Environment (badge)
     - Platform (icon + text)
     - Host:Port
     - Last Test (relative time)
     - Actions (Test, Edit, Delete buttons)
   - Sortable columns
   - Pagination controls
   
4. **Empty State**
   - "No servers configured"
   - "Add your first server" button
   - Helpful onboarding text

**Behavior:**
- Real-time status updates (if connection test running)
- Inline test button triggers test, shows spinner
- Delete button shows confirmation modal with dependency check
- Search filters locally + triggers API re-fetch on debounce

---

### 5.2 Server Create/Edit Page

**Path:** `/servers/new` or `/servers/:id/edit`

**Form Sections:**

1. **Basic Information**
   - Name (text input, required, validates uniqueness)
   - Environment (select: Production/Staging/Dev)
   - Tags (multi-input, chips)
   - Notes (textarea, optional)

2. **Connection Details**
   - Platform Type (select: Linux/Windows, disabled on edit)
   - Host (text input, validates hostname/IP)
   - Port (number input, default 22)
   - Protocol (select: SSH, disabled for now)
   - Username (text input)

3. **Authentication**
   - Auth Type (radio: SSH Key / SSH Key with Passphrase / Password)
   - Conditional fields based on auth type:
     - SSH Key: File upload or textarea
     - Passphrase: Password input (if applicable)
     - Password: Password input
   - Show/hide password toggle
   - Validation indicators (key format, etc.)

4. **Privilege & Execution**
   - Privilege Mode (select: Root / Sudo / User Only)
   - Sudo Mode (select: None / NOPASSWD / Password Required)
   - Sudo Password (if Password Required selected)

5. **Host Key Verification**
   - Strategy (select: Strict Pinned / TOFU / Disabled)
   - Warning badge if TOFU or Disabled
   - Known fingerprints section:
     - List of current fingerprints (if any)
     - Add fingerprint button
     - Remove fingerprint button
   - Fingerprint input: Key type + Fingerprint

**Actions:**
- Save button (validates all fields)
- Save & Test button (saves then runs test)
- Cancel button
- Delete button (edit mode only, with confirmation)

**Validation:**
- Real-time validation as user types
- Clear error messages below fields
- Cannot save with validation errors
- Credential format validation before save

---

### 5.3 Server Detail Page

**Path:** `/servers/:id`

**Layout:**

1. **Header**
   - Server name (editable inline or edit button)
   - Status badge (OK/Failed/Never Tested)
   - Actions: Edit, Test, Delete buttons

2. **Tabs**
   - **Overview**
     - Connection details (non-sensitive)
     - Platform, host, port, username
     - Environment, tags
     - Last test result (if available)
     - Authentication type indicator (not values)
     - Privilege mode indicator
   
   - **Test Results**
     - Latest test result (detailed)
     - Test history table (last 10 tests)
     - Test again button
   
   - **Host Keys**
     - Current host key strategy
     - List of known fingerprints with timestamps
     - Add/Remove fingerprint (SUPER_ADMIN only)
   
   - **Dependencies**
     - Sites using this server
     - Recent incidents
     - Scheduled jobs
     - Visual indicator if has dependencies
   
   - **Audit Log**
     - Server-specific audit events
     - Filterable by event type
     - Shows actor, action, timestamp

**Real-time Updates:**
- If test is running, show live progress
- Test result updates automatically when complete
- Status badge updates on test completion

---

### 5.4 Connection Test Modal/Drawer

**Trigger:** Click "Test Connection" button

**Content:**
1. **Progress Indicator**
   - Linear progress bar
   - Current step indicator:
     - Resolving hostname...
     - Connecting to server...
     - Verifying host key...
     - Authenticating...
     - Testing privileges...
     - Running commands...
     - Complete!

2. **Step Results**
   - Each step shows:
     - Check mark (success) or X (failed)
     - Time taken
     - Brief result message
   
3. **Final Result**
   - Success: Green banner with summary
   - Failure: Red banner with error message
   - Detected OS and username
   - Total latency
   - View Details button (expands full result)

4. **Actions**
   - Close button
   - Test Again button (if failed)
   - View Audit Log button

**Behavior:**
- Modal cannot be closed while test running
- Shows real-time progress via SSE or polling
- Auto-closes after 3 seconds on success (optional)
- Stays open on failure for user to review

---

### 5.5 Delete Confirmation Modal

**Trigger:** Click "Delete" button

**Content:**
1. **Warning**
   - "Are you sure you want to delete this server?"
   - Server name prominently displayed
   - Warning icon

2. **Dependency Check**
   - If no dependencies:
     - "This server is not currently in use and can be safely deleted."
   - If has dependencies:
     - "This server is currently in use by:"
     - List of dependencies (sites, incidents, jobs)
     - "Deleting this server may affect these resources."
     - Force delete checkbox (if allowed, SUPER_ADMIN only)

3. **Actions**
   - Cancel button (default focus)
   - Delete button (destructive style, requires confirmation)

**Behavior:**
- Fetches dependencies on modal open
- Shows loading state while checking
- Blocks deletion if dependencies exist (unless force)
- Force delete requires typing server name to confirm
- Shows success toast on completion

---

## 6. Non-Functional Requirements

### 6.1 Performance
- Server list loading: <500ms (without network tests)
- Server detail loading: <200ms
- Connection test: <60s timeout
- API response time: <200ms (except connection test)
- Support 500+ server profiles without degradation

### 6.2 Security
- All credentials encrypted at rest using libsodium (or specified algorithm)
- Host key verification enforced by default
- DISABLED host key verification requires explicit policy allowance
- Audit log for all security-relevant actions
- RBAC enforced on all endpoints
- Rate limiting on connection test endpoint (prevent abuse)

### 6.3 Reliability
- Connection test failures do not affect server profile
- Idempotent operations where applicable
- Graceful error handling and recovery
- Database transactions for critical operations
- Soft-delete for audit trail

### 6.4 Scalability
- Horizontal scaling supported (stateless API)
- Database connection pooling
- Efficient queries with proper indexes
- Pagination on all list endpoints

### 6.5 Maintainability
- Clean code architecture
- Dependency injection
- Unit test coverage >80%
- Integration tests for critical flows
- API documentation (Swagger)
- Code comments for complex logic

---

## 7. Testing Requirements

### 7.1 Unit Tests

**Backend Services:**
- Credential encryption/decryption
- Host key verification logic
- Server profile validation
- Dependency checking logic
- RBAC permission checking
- Audit log creation

**Frontend Components:**
- Form validation
- Server list filtering/sorting
- Connection test progress display
- Dependency modal logic

---

### 7.2 Integration Tests

**API Endpoints:**
- Create server (success/failure cases)
- Update server (partial updates)
- Delete server (with/without dependencies)
- Connection test (mock SSH connection)
- List servers (pagination, filters)
- Get dependencies

**Workflows:**
- Complete server creation flow
- Update credentials workflow
- Host key update workflow
- Connection test with various failure modes

---

### 7.3 E2E Tests (Playwright)

**User Journeys:**
1. Admin creates new server via UI
2. Admin tests connection and sees results
3. Admin updates server credentials
4. Admin attempts to delete server with dependencies (blocked)
5. Admin views server audit log
6. Engineer tests connection (has permission)
7. Engineer attempts to edit server (blocked, no permission)
8. SUPER_ADMIN updates host key fingerprints

---

### 7.4 Security Tests

**Penetration Tests:**
- Attempt to retrieve credentials via API
- Attempt to bypass host key verification
- SQL injection attempts
- Command injection via server fields
- CSRF attempts
- Privilege escalation attempts

**Compliance Tests:**
- Verify credentials encrypted at rest
- Verify credentials never logged
- Verify RBAC enforced
- Verify audit logs complete
- Verify host key verification enforced

---

## 8. Dependencies & Integration

### 8.1 Integration with Auth Module

**Required from Auth Module:**
- User authentication (JWT validation)
- RBAC permission checking
- Audit log service (shared)
- Encryption service (if shared)

**API Calls:**
```typescript
// Check user permission
authService.hasPermission(userId, 'servers.create')

// Create audit log
auditService.log({
  userId,
  action: 'SERVER_CREATED',
  resource: 'server',
  resourceId: serverId,
  // ...
})

// Encrypt credential
encryptionService.encrypt(plaintext)

// Decrypt credential
encryptionService.decrypt(ciphertext)
```

---

### 8.2 Integration with Future Modules

**Provided to Other Modules:**

```typescript
// Server profile retrieval (with decrypted credentials)
interface ServerConnectionService {
  // Get server profile for connection use
  getServerForConnection(serverId: string): Promise<{
    host: string
    port: number
    username: string
    authType: string
    credentials: {
      privateKey?: string  // Decrypted
      passphrase?: string  // Decrypted
      password?: string    // Decrypted
    }
    privilegeMode: string
    sudoMode: string
    sudoPassword?: string  // Decrypted
    hostKeyStrategy: string
    knownHostFingerprints: HostKeyFingerprint[]
  }>
  
  // Verify host key during connection
  verifyHostKey(serverId: string, actualFingerprint: string): Promise<boolean>
  
  // Update last test result
  updateTestResult(serverId: string, result: TestResult): Promise<void>
  
  // Check if server can be deleted
  canDeleteServer(serverId: string): Promise<{
    canDelete: boolean
    dependencies: Dependency[]
  }>
}
```

---

## 9. Acceptance Criteria

**Module is complete when:**

âœ… All functional requirements (FR-SERVER-001 through FR-SERVER-013) implemented  
âœ… All API endpoints working and documented (Swagger)  
âœ… All UI pages implemented and functional  
âœ… Unit test coverage >80%  
âœ… Integration tests passing  
âœ… E2E tests passing  
âœ… Security tests passing  
âœ… Credentials properly encrypted at rest  
âœ… Host key verification working  
âœ… Connection testing working (Linux at minimum)  
âœ… Dependency checking working  
âœ… RBAC enforced on all endpoints  
âœ… Audit logging complete  
âœ… Documentation complete  

---

## 10. Success Metrics

- Connection test success rate >95% (for known-good servers)
- API response time <200ms (excluding connection tests)
- Zero credential leaks in logs or API responses
- Zero unauthorized access to server profiles
- 100% audit coverage for security events
- Zero SQL injection vulnerabilities
- Zero host key verification bypasses (when STRICT_PINNED)

---

## 11. Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Credential encryption key leak | Critical | Low | Key stored separately, rotation supported |
| SSH connection timeout issues | Medium | Medium | Configurable timeout, retry logic |
| Host key legitimate rotation | Medium | Low | SUPER_ADMIN workflow for updates |
| Dependency tracking incomplete | High | Medium | Comprehensive integration testing |
| Windows support complexity | Medium | Medium | Extensible design, phased implementation |
| Connection test abuse (DOS) | Medium | Low | Rate limiting, permission-based |

---

## 12. Future Enhancements (Post-MVP)

1. **Connection Pooling**
   - Reuse connections for efficiency
   - Connection lifecycle management

2. **SSH Tunneling/Port Forwarding**
   - Support for bastion/jump hosts
   - Port forwarding for database access

3. **Agent-Based Monitoring**
   - Install lightweight agent on servers
   - Real-time health metrics

4. **Credential Rotation**
   - Automated SSH key rotation
   - Password rotation policies

5. **IP Allowlisting**
   - Restrict connections to specific IPs
   - Geo-blocking

6. **Multi-Protocol Support**
   - WinRM for Windows
   - RDP for Windows desktop
   - Ansible playbook execution

7. **Server Groups**
   - Logical grouping of servers
   - Bulk operations

8. **Advanced RBAC**
   - Per-server permissions
   - Server ownership

---

## 13. Open Questions & Required Clarifications

### ðŸ”´ CRITICAL CLARIFICATIONS NEEDED:

1. **Windows Connection Protocol**
   - What protocol(s) should be supported for Windows servers?
   - Options: SSH (OpenSSH on Windows), WinRM, PowerShell Remoting?
   - Should this be configurable per server?

2. **Windows Test Commands**
   - What minimal commands should be run on Windows for connection testing?
   - Windows equivalent of `whoami` and `uname -a`?
   - Example: `whoami` and `systeminfo`?

3. **Encryption Service**
   - Should this module use the Auth module's encryption service?
   - Or create its own separate encryption service?
   - Should encryption key be shared with Auth module or separate?

4. **Multi-Tenancy**
   - Is this a multi-tenant system?
   - Server names unique per tenant or globally?
   - Tenant isolation required in database?

5. **Soft Delete vs Hard Delete**
   - Should deletion always be soft-delete (recommended)?
   - Or allow hard-delete option?
   - If soft-delete, retention period before hard-delete?

6. **Connection Timeout Values**
   - TCP connection timeout (suggest: 30 seconds)?
   - Authentication timeout (suggest: 20 seconds)?
   - Command execution timeout (suggest: 10 seconds)?
   - Total test timeout (suggest: 60 seconds)?

7. **Retry Logic**
   - Should connection tests have automatic retries?
   - If yes, how many retries?
   - Backoff strategy?

8. **Rate Limiting**
   - Should connection tests be rate-limited per server?
   - Suggested limit: Max 5 tests per server per hour?
   - Global rate limit on connection tests?

9. **Force Delete Policy**
   - When is force deletion of servers allowed?
   - SUPER_ADMIN only?
   - What additional confirmations required?

10. **Sudo Password Handling**
    - If sudoMode = PASSWORD_REQUIRED, sudo password stored in server profile?
    - Or prompted at connection time?
    - Security implications?

11. **Host Key Update Workflow**
    - When server's host key legitimately changes (reinstall, etc):
    - Should system auto-detect and prompt for confirmation?
    - Or require manual SUPER_ADMIN update?

12. **Connection Pooling**
    - Should connections be pooled for reuse by other modules?
    - Or created fresh per request?
    - If pooled, max pool size per server?

13. **Database Shared or Separate**
    - Should this module share database with Auth module?
    - Or use separate database for isolation?

14. **API Versioning**
    - Confirm API version: `/api/v1`?

15. **Pagination Strategy**
    - Cursor-based or offset-based pagination?
    - Default page size (suggested: 50)?
    - Max page size (suggested: 100)?

16. **Credential Validation**
    - Should SSH key format be validated before save?
    - Password strength requirements?
    - Or defer validation to connection test?

17. **Host Key Strategy Enforcement**
    - Can system policy completely disallow DISABLED host key verification?
    - Or just log critical warnings?

18. **Audit Log Retention**
    - Separate retention policy for server audit logs?
    - Or follow system-wide audit retention (90 days)?

19. **Test Result Retention**
    - How many historical test results to keep per server?
    - Suggested: Last 10 tests?

20. **Platform Type Extensibility**
    - Current: LINUX, WINDOWS
    - Future: MACOS, BSD, others?
    - Design for extensibility now?

---

## 14. Assumptions Made (To Be Validated)

**The following assumptions were made in creating these requirements. Please confirm or correct:**

1. âœ… Assumed: System is Docker-based (as confirmed)
2. âœ… Assumed: PostgreSQL database (as per WP-AutoHealer design)
3. âœ… Assumed: Redis available (as per WP-AutoHealer design)
4. âš ï¸ Assumed: Linux servers use SSH protocol (needs confirmation for Windows)
5. âš ï¸ Assumed: Encryption service available from Auth module (needs confirmation)
6. âš ï¸ Assumed: Soft-delete preferred (needs confirmation)
7. âš ï¸ Assumed: Connection test timeout 60 seconds (needs confirmation)
8. âš ï¸ Assumed: No automatic retries on connection test (needs confirmation)
9. âš ï¸ Assumed: Server names unique globally, not per-tenant (needs clarification on multi-tenancy)
10. âš ï¸ Assumed: Sudo password stored encrypted in server profile (needs confirmation on security policy)

---

## 15. Next Steps

**Before implementation can begin:**

1. **Review this functional requirements document**
2. **Answer all 20 clarification questions above**
3. **Validate or correct all 10 assumptions**
4. **Approve final requirements**

**After approval:**
- I will await your instruction on whether to:
  - A) Proceed to next module's functional requirements
  - B) Provide additional design artifacts for this module
  - C) Something else

---

**END OF FUNCTIONAL REQUIREMENTS**

**Status:** Draft - Awaiting clarifications on 20 questions and validation of 10 assumptions before approval.


----------------------------------------------------
3. Notes & skipped functionality for future versions
----------------------------------------------------


```prisma
model Server {
  // Identity
  id                    String    @id @default(uuid()) @map("server_id")
  name                  String    @unique
  environment           String?   @db.VarChar(20)
  tags                  String[]
  notes                 String?   @db.VarChar(1000)
  
  // Connection
  platformType          String    @db.VarChar(20)
  host                  String    @db.VarChar(255)
  port                  Int
  connectionProtocol    String    @db.VarChar(20)
  username              String    @db.VarChar(100)
  
  // Authentication (encrypted)
  authType              String    @db.VarChar(50)
  encryptedPrivateKey   String?   @db.Text
  encryptedPassphrase   String?   @db.Text
  encryptedPassword     String?   @db.Text
  
  // Privilege & Execution
  privilegeMode         String    @db.VarChar(20)
  sudoMode              String    @db.VarChar(30)
  encryptedSudoPassword String?   @db.Text
  
  // Host Key Verification
  hostKeyStrategy       String    @db.VarChar(30)
  knownHostFingerprints Json?
  
  // Operational
  lastTestStatus        String?   @db.VarChar(20)
  lastTestAt            DateTime?
  lastTestResult        Json?
  
  // Metadata
  createdByUserId       String
  createdBy             User      @relation(fields: [createdByUserId], references: [id])
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?
  
  @@index([name])
  @@index([host])
  @@index([platformType])
  @@index([environment])
  @@index([lastTestStatus])
  @@index([deletedAt])
  @@map("servers")
}
```

---

## API Specification

### Endpoints

#### POST /api/v1/servers
Create new server profile

**Request Body:**
```json
{
  "name": "Production Web Server 1",
  "environment": "PROD",
  "tags": ["web", "wordpress", "us-east"],
  "notes": "Main production server",
  "platformType": "LINUX",
  "host": "prod1.example.com",
  "port": 22,
  "connectionProtocol": "SSH",
  "username": "deployer",
  "authType": "SSH_KEY_WITH_PASSPHRASE",
  "credentials": {
    "privateKey": "-----BEGIN OPENSSH PRIVATE KEY-----\n...",
    "passphrase": "secure-passphrase"
  },
  "privilegeMode": "SUDO",
  "sudoMode": "NOPASSWD",
  "hostKeyStrategy": "STRICT_PINNED",
  "knownHostFingerprints": [
    {
      "keyType": "ssh-ed25519",
      "fingerprint": "SHA256:abc123..."
    }
  ]
}
```

**Response:** 201 Created
```json
{
  "serverId": "srv_abc123",
  "name": "Production Web Server 1",
  "environment": "PROD",
  "platformType": "LINUX",
  "host": "prod1.example.com",
  "port": 22,
  "lastTestStatus": "NEVER_TESTED",
  "createdAt": "2026-02-07T10:00:00Z"
}
```

#### GET /api/v1/servers
List servers with pagination and filtering

**Query Parameters:**
- `page` (default: 1)
- `limit` (default: 50, max: 100)
- `sort` (default: name)
- `order` (default: asc)
- `search` (searches name, host, tags)
- `platformType` (LINUX, WINDOWS)
- `environment` (PROD, STAGING, DEV)
- `lastTestStatus` (NEVER_TESTED, OK, FAILED)

**Response:** 200 OK
```json
{
  "data": [
    {
      "serverId": "srv_abc123",
      "name": "Production Web Server 1",
      "environment": "PROD",
      "platformType": "LINUX",
      "host": "prod1.example.com",
      "port": 22,
      "lastTestStatus": "OK",
      "lastTestAt": "2026-02-07T10:05:00Z"
    }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "limit": 50,
    "totalPages": 3
  }
}
```

#### POST /api/v1/servers/:id/test
Test server connection

**Response:** 200 OK
```json
{
  "success": true,
  "message": "Connection test successful",
  "latency": 145,
  "testedAt": "2026-02-07T10:10:00Z",
  "details": {
    "dnsResolution": {
      "success": true,
      "ip": "192.168.1.100",
      "time": 20
    },
    "tcpConnection": {
      "success": true,
      "time": 45
    },
    "hostKeyVerification": {
      "success": true,
      "keyType": "ssh-ed25519",
      "matched": true
    },
    "authentication": {
      "success": true
    },
    "privilegeTest": {
      "success": true,
      "hasSudo": true
    },
    "commandExecution": {
      "whoami": {
        "success": true,
        "output": "deployer"
      },
      "systemInfo": {
        "success": true,
        "output": "Linux prod1 5.15.0 Ubuntu"
      }
    }
  },
  "detectedOS": "Ubuntu 24.04 LTS",
  "detectedUsername": "deployer",
  "errors": [],
  "warnings": []
}
```

---

## Security Considerations

### Credential Protection
1. **Encryption at Rest**
   - All credentials encrypted using libsodium XSalsa20-Poly1305
   - Encryption key stored separately from database
   - Key rotation supported

2. **Encryption in Transit**
   - TLS 1.3 for all API communications
   - SSH protocol for server connections
   - No credentials in URLs or logs

3. **Access Control**
   - RBAC enforced on all endpoints
   - Credentials never returned in API responses
   - Audit logging for all credential access

### Host Key Verification
1. **STRICT_PINNED (Recommended)**
   - Compare against known fingerprints
   - Deny connection on mismatch
   - Log critical security event

2. **TOFU (Trust On First Use)**
   - Accept and store on first connection
   - Verify on subsequent connections
   - Log warning on first use

3. **DISABLED (Requires Policy)**
   - Skip verification (not recommended)
   - Log critical warning on every connection
   - Requires explicit system policy allowance

### Audit Logging
All security-relevant events logged:
- Server creation/update/deletion
- Credential changes
- Connection test results
- Host key mismatches
- Permission denials

---

## Performance Requirements

### Response Times
- Server list: <500ms
- Server detail: <200ms
- Connection test: <60s (timeout)
- Create/Update: <300ms
- Delete: <200ms

### Scalability
- Support 500+ server profiles
- Handle 100 concurrent connection tests
- Database query optimization with indexes
- Connection pooling for efficiency

### Caching Strategy
- Server list cached in Redis (5 min TTL)
- Test results cached (1 hour TTL)
- Invalidate cache on updates

---

## Testing Strategy

### Unit Tests (Target: >80% Coverage)
- Encryption/decryption functions
- Validation logic
- Host key verification
- Credential sanitization
- Permission checking

### Integration Tests
- CRUD operations
- Connection testing flow
- Dependency checking
- Audit log creation
- RBAC enforcement

### E2E Tests (Playwright)
- Admin creates server via UI
- Admin tests connection
- Admin updates credentials
- Admin attempts delete with dependencies
- Engineer tests connection (has permission)
- Engineer attempts edit (blocked)

### Security Tests
- Credential leak prevention
- SQL injection attempts
- Command injection attempts
- Host key bypass attempts
- Permission escalation attempts

---

## Deployment Checklist

### Pre-Deployment
- [ ] Database migrations tested
- [ ] Encryption keys generated and secured
- [ ] Environment variables configured
- [ ] RBAC permissions seeded
- [ ] Test data prepared

### Deployment
- [ ] Run database migrations
- [ ] Deploy backend service
- [ ] Deploy frontend application
- [ ] Verify health checks
- [ ] Run smoke tests

### Post-Deployment
- [ ] Monitor error rates
- [ ] Check audit logs
- [ ] Verify connection tests
- [ ] Test RBAC enforcement
- [ ] Review performance metrics

---

## Success Metrics

### Functional Metrics
- âœ… All FR-SERVER-001 through FR-SERVER-013 implemented
- âœ… Connection test success rate >95%
- âœ… Zero credential leaks
- âœ… 100% audit coverage

### Performance Metrics
- âœ… API response time <200ms (p95)
- âœ… Connection test <60s
- âœ… Support 500+ servers
- âœ… Handle 100 concurrent tests

### Security Metrics
- âœ… Zero authentication bypasses
- âœ… Zero credential exposures
- âœ… 100% RBAC enforcement
- âœ… Complete audit trail

---

## Risk Mitigation

### Technical Risks
| Risk | Mitigation |
|------|------------|
| SSH connection timeouts | Configurable timeouts, retry logic |
| Encryption key leak | Separate key storage, rotation support |
| Host key rotation | SUPER_ADMIN update workflow |
| Windows support complexity | Extensible design, phased implementation |

### Operational Risks
| Risk | Mitigation |
|------|------------|
| Dependency tracking incomplete | Comprehensive integration testing |
| Connection test abuse | Rate limiting, permission-based access |
| Credential rotation | Automated rotation support (future) |

---

## Future Enhancements

### Phase 2 Features
1. **Connection Pooling**
   - Reuse connections for efficiency
   - Connection lifecycle management
   - Pool size configuration

2. **SSH Tunneling**
   - Support for bastion/jump hosts
   - Port forwarding capabilities
   - Multi-hop connections

3. **Agent-Based Monitoring**
   - Lightweight agent installation
   - Real-time health metrics
   - Automatic discovery

4. **Credential Rotation**
   - Automated SSH key rotation
   - Password rotation policies
   - Rotation scheduling

5. **Advanced RBAC**
   - Per-server permissions
   - Server ownership
   - Team-based access

---

## Documentation Deliverables

### Technical Documentation
- [ ] Architecture diagrams
- [ ] Database schema documentation
- [ ] API documentation (Swagger)
- [ ] Security architecture
- [ ] Deployment guide

### User Documentation
- [ ] Server management guide
- [ ] Connection testing guide
- [ ] Troubleshooting guide
- [ ] Best practices guide

### Developer Documentation
- [ ] Setup guide
- [ ] Contributing guidelines
- [ ] Testing guide
- [ ] Security guidelines

---

## Appendix: Original Requirements

[Original requirements preserved below for reference]

---
